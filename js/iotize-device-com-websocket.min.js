!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("rxjs"),require("rxjs/operators"),require("IoTizeDeviceClient.Protocol.Api"),require("IoTizeDeviceClient.Protocol.Impl"),require("IoTizeDeviceClient.Core")):"function"==typeof define&&define.amd?define(["rxjs","rxjs/operators",,,],t):"object"==typeof exports?exports.IoTizeDeviceComWebsocket=t(require("rxjs"),require("rxjs/operators"),require("IoTizeDeviceClient.Protocol.Api"),require("IoTizeDeviceClient.Protocol.Impl"),require("IoTizeDeviceClient.Core")):e.IoTizeDeviceComWebsocket=t(e.rxjs,e.rxjs.operators,e.IoTizeDeviceClient.Protocol.Api,e.IoTizeDeviceClient.Protocol.Impl,e.IoTizeDeviceClient.Core)}(window,function(e,t,o,r,n){return function(e){var t={};function o(r){if(t[r])return t[r].exports;var n=t[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,o),n.l=!0,n.exports}return o.m=e,o.c=t,o.d=function(e,t,r){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(o.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)o.d(r,n,function(t){return e[t]}.bind(null,n));return r},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=0)}([function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var o in e)t.hasOwnProperty(o)||(t[o]=e[o])}(o(1))},function(e,t,o){"use strict";var r=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o])};return function(t,o){function r(){this.constructor=t}e(t,o),t.prototype=null===o?Object.create(o):(r.prototype=o.prototype,new r)}}();Object.defineProperty(t,"__esModule",{value:!0});var n=o(2),i=o(3),c=o(4),s=o(5),u=o(6),a=o(7),l=function(e){function t(t){var o=e.call(this)||this;return o.params=t,o}return r(t,e),t.prototype._connect=function(e){var o=this;console.log(t.TAG,"Connecting to "+this.params.url+"..."),this._receiveStream=new n.Subject;var r=new Promise(function(e,r){o.ws=new WebSocket(o.params.url),o.ws.onclose=function(){console.log("Websocket has been closed. Disconnecting"),o.isConnected()&&o._checkReadyState()},o.ws.onopen=function(o){console.log(t.TAG,"Websocket is now open !"),e(o)},o.ws.onmessage=function(e){try{console.log("Message received from "+e.origin+"  "+e.data+" (type="+typeof e.data+")");var t=e.data;if(t instanceof Uint8Array)o.notifyNewMessage(t);else if("string"==typeof t)t=new Uint8Array(u.FormatHelper.toByteBuffer(t)),o.notifyNewMessage(t);else{if(t instanceof Blob)return console.log("Blob data need to be converted..."),void a.Util.blobToUint8Array(t).then(function(e){o.notifyNewMessage(e)}).catch(function(e){o.notifyNewError(e)});var r=new Error("onmessage Received invalid data type: "+typeof t);o.notifyNewError(r)}}catch(r){console.error("Unexpected error occured in onmessage",r),o.notifyNewError(r)}},o.ws.onerror=function(e){console.log("Error received: "+e.type,e),r(e)}});return n.of(r)},t.prototype._disconnect=function(e){return this.ws&&this.ws.close(),n.of(!0)},t.prototype.write=function(e){try{return console.log("write "+u.FormatHelper.toHexString(e)),this._checkReadyState(),this.ws.send(e),Promise.resolve()}catch(e){return Promise.reject(e)}},t.prototype.read=function(){try{return this._checkReadyState(),this.readOneValue()}catch(e){return Promise.reject(e)}},t.prototype.readOneValue=function(){var e=this;return console.log("WebSocketProtocol","readOneValue","INIT"),new Promise(function(t,o){e._receiveStream.pipe(i.first()).subscribe({next:function(e){console.log("WebSocketProtocol","readOneValue","RESOLVING...",u.FormatHelper.toHexString(e)),t(e)},error:function(e){o(e)}})})},t.prototype.notifyNewMessage=function(e){console.log("notifyNewMessage() "+u.FormatHelper.toHexString(e)),this._receiveStream.next(e)},t.prototype.notifyNewError=function(e){this._receiveStream.error(e)},t.prototype.receiveStream=function(){return this._receiveStream},t.prototype._checkReadyState=function(){if(!this.ws)return this.setConnectionState(c.ConnectionState.DISCONNECTED),!1;switch(this.ws.readyState){case this.ws.OPEN:return!0;case this.ws.CLOSED:return this.setConnectionState(c.ConnectionState.DISCONNECTED),!1;case this.ws.CLOSING:return this.setConnectionState(c.ConnectionState.DISCONNECTING),!1;case this.ws.CONNECTING:return this.setConnectionState(c.ConnectionState.CONNECTING),!1;default:return!1}},t.TAG="WebSocketProtocol",t}(s.QueueComProtocol);t.WebSocketProtocol=l},function(t,o){t.exports=e},function(e,o){e.exports=t},function(e,t){e.exports=o},function(e,t){e.exports=r},function(e,t){e.exports=n},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(){}return e.blobToUint8Array=function(e){var t=new FileReader;return new Promise(function(o,r){t.onloadend=function(e){if(e.target){console.log("Convertion result type "+typeof t.result+" ",e);var n=e.target.result;o(new Uint8Array(n))}else r(new Error("Null target"))},t.onerror=r,t.readAsArrayBuffer(e)})},e}();t.Util=r}])});